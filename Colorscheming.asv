%% COLOR FUNCTION


clc
lung = [-700, -600];
fat = [-120, -90];
fluids = [-30 15];
water = [-2, 2 ];
muscle = [30 55];
blood = [13 50 ];
hematoma = [50 100];
clot = [50 75 ];
cancellous = [300 400];
cortical = [1000 1900];
foreign = [2500 3000];
noise = [-700 1500];
cols = ['r' 'y' 'c' 'b' 'r' 'r' 'r' 'k' 'k' 'g'];
cats = [lung; fat;fluids; water; muscle; blood; hematoma; clot; cancellous; cortical; foreign; ];
catnames = ["lung", "fat", "fluids", "water" "muscle" "blood" "hematoma" "clot" "cancellous" "cortical" "foreign"];
min_belonging = 0.0001;

x = -1000:0.2:2000;
for i = 1:length(cats)
   spread = cats(i,2)-cats(i,1);
   center = (cats(i,1) + cats(i,2))/2;
   sd = spread/4;
   f = 1/(sd*sqrt(2*3.1415)) *exp(-((x-center).^2)/(2*sd^2));
   f = plot(x, f);
   %legend(catnames(i))
   hold on
end
%set(gca, 'YScale', 'log')
ylabel("Inclusion")
xlabel("Hounsfield unit")
legend(catnames)
axis([-100 100 min_belonging 0.08])
hold off

%%  ACTIVATION FUNCTION
clc
blocks = 9*5;
x = 1:1:blocks+3;
x = 0:1:9;
f = 1-1./(1+exp(-x/2));
plot(x, f)



%% ACCUMULATED ALPHA FUNCTION
x = 0:1:10;
y = 1./x.^2;
plot(x,y)







%% Image normalization
y = [0.000000, 388, 320, 279, 231, 204, 188, 168, 165, 136, 143, 109, 114, 103, 106, 80, 91, 87, 84, 77, 66, 66, 64, 64, 54, 43, 52, 35, 27, 35, 28, 29, 32, 37, 25, 20, 16, 21, 8, 12, 10, 14, 31, 14, 14, 19, 19, 14, 16, 17, 16, 16, 17, 6, 11, 9, 18, 21, 16, 26, 15, 21, 19, 9, 17, 16, 20, 19, 14, 19, 20, 18, 19, 19, 15, 23, 13, 16, 13, 17, 31, 16, 21, 21, 16, 28, 18, 18, 20, 27, 17, 27, 26, 22, 23, 21, 23, 27, 22, 27, 18, 25, 19, 30, 23, 27, 25, 32, 27, 27, 22, 14, 27, 16, 41, 25, 23, 37, 30, 14, 30, 30, 16, 34, 31, 29, 30, 25, 26, 23, 28, 28, 26, 28, 32, 35, 32, 25, 24, 38, 17, 34, 40, 28, 39, 38, 31, 32, 28, 38, 35, 27, 40, 28, 39, 42, 29, 54, 35, 53, 27, 56, 45, 36, 60, 49, 85, 68, 56, 114, 90, 128, 150, 148, 182, 161, 215, 219, 333, 279, 422, 555, 699, 695, 718, 873, 1024, 1250, 1383, 1562, 1824, 1968, 2238, 2429, 2643, 2741, 2901, 3045, 3179, 3532, 3702, 3896, 3643, 3813, 3842, 4117, 3981, 3988, 3919, 3834, 3611, 3539, 3428, 3381, 3017, 2829, 2565, 2386, 2279, 2035, 2005, 1924, 1682, 1491, 1468, 1265, 1210, 1044, 961, 965, 927, 966, 895, 925, 871, 945, 938, 808, 866, 913, 863, 900, 960, 937, 957, 1008, 1068, 1081, 1120, 1042, 1314, 1357, 1371, 1439, 1603, 1514, 1760, 1769, 2123, 1995, 2202, 2340, 2659, 2724, 3079, 3207, 3418, 3710, 4253, 4554, 4692, 5153, 5319, 5502, 6281, 6455, 6603, 6561, 6952, 6864, 6830, 7501, 7205, 7330, 7266, 7006, 6796, 6462, 6357, 6003, 5975, 5575, 5508, 5268, 4744, 4376, 3871, 3655, 3360, 2836, 2583, 2316, 1974, 1695, 1578, 1310, 1227, 901, 910, 739, 680, 552, 463, 388, 394, 286, 241, 194, 168, 158, 92, 128, 92, 78, 77, 102, 72, 67, 53, 52, 50, 52, 59, 29, 30, 40, 48, 33, 45, 42, 24, 36, 33, 33, 26, 37, 32, 39, 31, 31, 34, 33, 30, 42, 30, 23, 28, 30, 27, 26, 36, 29, 25, 38, 33, 36, 36, 41, 35, 36, 35, 47, 33, 67, 56, 47, 67, 60, 47, 42, 76, 66, 98, 97, 126, 124, 101, 106, 121, 110, 139, 115, 132, 102, 118, 105, 103, 142, 147, 156, 147, 130, 105, 105, 150, 117, 92, 86, 93, 76, 106, 74, 64, 41, 57, 55, 53, 50, 51, 59, 68, 71, 68, 88, 101, 79, 59, 90, 96, 68, 91, 93, 102, 99, 91, 102, 124, 103, 123, 138, 132, 150, 108, 126, 98, 76, 74, 98, 104, 101, 66, 73, 67, 80, 55, 52, 75, 42, 11, 11, 4, 7, 0, 7, 0, 1, 0, 0, 1, 9, 0, 0, 0, 1, 0, 1, 0, 2, 1, 7, 4, 2, 7, 6, 13, 10, 12, 16, 12, 14, 34, 24, 22, 32, 31, 40, 32, 34, 24, 31];

original = [0.000000, 110, 84, 122, 102, 98, 103, 115, 99, 111, 97, 103, 94, 105, 98, 99, 108, 103, 109, 86, 104, 107, 113, 104, 97, 112, 94, 95, 96, 110, 109, 84, 98, 109, 100, 95, 89, 99, 87, 103, 95, 89, 90, 83, 102, 91, 93, 103, 81, 95, 100, 95, 103, 85, 81, 99, 121, 98, 90, 100, 80, 108, 98, 96, 112, 91, 97, 117, 97, 115, 123, 109, 102, 120, 105, 118, 109, 90, 128, 101, 101, 110, 111, 116, 116, 119, 122, 116, 105, 129, 136, 123, 125, 131, 138, 124, 143, 127, 124, 148, 137, 152, 151, 157, 136, 157, 176, 156, 149, 173, 187, 169, 194, 183, 163, 175, 185, 175, 216, 182, 209, 214, 252, 240, 232, 231, 271, 239, 273, 266, 312, 308, 305, 315, 330, 358, 348, 347, 372, 414, 352, 447, 477, 439, 485, 481, 500, 488, 547, 548, 573, 611, 625, 630, 684, 676, 693, 753, 730, 756, 832, 828, 838, 837, 915, 976, 940, 939, 947, 1016, 1034, 1108, 1068, 1086, 1172, 1217, 1196, 1202, 1242, 1225, 1300, 1219, 1373, 1301, 1377, 1396, 1352, 1427, 1498, 1448, 1462, 1535, 1526, 1522, 1544, 1527, 1563, 1558, 1617, 1581, 1606, 1625, 1666, 1643, 1579, 1652, 1698, 1630, 1686, 1616, 1691, 1664, 1609, 1751, 1667, 1657, 1688, 1644, 1703, 1603, 1660, 1730, 1612, 1638, 1721, 1670, 1669, 1643, 1655, 1610, 1636, 1530, 1620, 1624, 1654, 1618, 1666, 1630, 1613, 1624, 1625, 1627, 1643, 1587, 1590, 1582, 1630, 1635, 1547, 1661, 1615, 1627, 1620, 1734, 1599, 1691, 1600, 1569, 1655, 1575, 1602, 1642, 1673, 1630, 1577, 1648, 1642, 1553, 1662, 1593, 1545, 1648, 1559, 1581, 1587, 1581, 1541, 1477, 1563, 1587, 1620, 1514, 1540, 1451, 1467, 1521, 3537, 1389, 2374, 1441, 1341, 1438, 1363, 1403, 1381, 1316, 1319, 1349, 1355, 1287, 1311, 1310, 1231, 1253, 1245, 1174, 1184, 1217, 1173, 1085, 1115, 1157, 1026, 1133, 1089, 1047, 1022, 1011, 943, 1042, 1029, 1007, 945, 967, 942, 922, 894, 927, 927, 875, 887, 848, 860, 824, 787, 813, 822, 786, 781, 802, 793, 790, 764, 746, 693, 814, 755, 760, 736, 686, 695, 674, 700, 702, 687, 642, 649, 658, 632, 609, 611, 599, 613, 571, 585, 564, 563, 533, 581, 559, 567, 577, 552, 498, 513, 492, 484, 519, 460, 459, 455, 431, 438, 453, 373, 397, 387, 383, 363, 387, 373, 359, 344, 378, 341, 309, 311, 325, 306, 276, 280, 319, 271, 276, 282, 229, 241, 228, 226, 253, 238, 260, 204, 226, 214, 214, 211, 182, 219, 191, 175, 173, 193, 188, 185, 165, 128, 173, 150, 158, 166, 149, 140, 118, 140, 148, 153, 139, 110, 131, 118, 128, 118, 133, 117, 107, 113, 113, 111, 107, 101, 92, 80, 92, 118, 110, 90, 71, 87, 92, 90, 99, 80, 95, 77, 92, 83, 72, 86, 81, 83, 92, 76, 75, 83, 72, 70, 84, 92, 65, 81, 84, 77, 66, 76, 70, 73, 75, 64, 63, 72, 66, 64, 82, 74, 79, 75, 63, 66, 67];
median = [0.000000, 32, 13, 39, 38, 21, 35, 62, 32, 37, 29, 37, 33, 39, 39, 67, 72, 26, 63, 42, 56, 41, 76, 66, 44, 56, 45, 49, 77, 72, 78, 32, 36, 56, 63, 72, 50, 73, 62, 61, 40, 48, 53, 49, 61, 63, 53, 68, 38, 54, 80, 63, 84, 65, 38, 65, 103, 92, 74, 94, 52, 97, 77, 71, 105, 57, 63, 130, 93, 79, 118, 75, 93, 104, 96, 76, 88, 77, 97, 110, 105, 105, 112, 135, 83, 127, 182, 164, 135, 141, 162, 151, 174, 173, 170, 185, 222, 164, 155, 199, 227, 217, 247, 268, 202, 283, 251, 268, 238, 268, 304, 327, 415, 381, 314, 292, 354, 387, 346, 345, 454, 461, 518, 530, 511, 478, 688, 490, 661, 621, 746, 788, 784, 826, 875, 929, 855, 998, 1071, 966, 855, 1216, 1433, 1277, 1327, 1211, 1286, 1321, 1572, 1432, 1577, 1802, 1846, 1679, 2054, 1848, 1996, 2083, 1989, 2001, 2054, 2300, 2210, 2221, 2333, 2380, 2287, 2106, 2206, 2269, 2456, 2246, 2257, 2399, 2466, 2322, 2323, 2330, 2273, 2328, 2481, 1889, 2263, 2019, 2035, 2089, 2040, 2004, 2017, 2111, 1976, 1933, 1772, 1871, 1714, 1461, 1914, 1676, 1576, 1616, 1560, 1544, 1514, 1623, 1440, 1549, 1652, 1771, 1622, 1543, 1769, 1503, 1622, 1573, 1476, 1604, 1710, 1579, 1649, 1548, 1612, 1678, 1469, 1548, 1800, 1849, 1929, 1599, 1667, 1855, 1807, 1564, 1707, 1622, 2001, 1663, 1746, 1648, 1787, 1832, 1874, 1739, 1853, 1801, 1796, 1771, 1756, 1646, 1737, 1943, 1807, 1682, 1783, 1844, 1812, 1748, 1579, 1629, 1614, 1523, 1405, 1449, 1516, 1286, 1259, 1362, 1265, 1197, 1270, 1159, 987, 1162, 1103, 1046, 1058, 911, 936, 788, 918, 741, 772, 684, 813, 797, 692, 682, 2777, 596, 1542, 645, 570, 502, 564, 626, 543, 544, 580, 464, 649, 482, 505, 645, 569, 548, 520, 415, 528, 461, 612, 572, 438, 576, 477, 598, 488, 557, 473, 579, 568, 481, 754, 605, 554, 665, 611, 609, 531, 583, 549, 595, 477, 545, 485, 466, 541, 462, 566, 445, 423, 501, 376, 381, 365, 449, 350, 394, 290, 347, 266, 233, 342, 257, 315, 273, 243, 273, 261, 221, 199, 178, 230, 174, 139, 155, 207, 76, 128, 114, 120, 108, 140, 105, 76, 109, 69, 59, 89, 80, 71, 80, 109, 69, 71, 51, 71, 49, 63, 48, 53, 63, 64, 105, 85, 65, 73, 48, 76, 73, 27, 45, 45, 59, 57, 112, 85, 51, 58, 43, 76, 96, 83, 65, 36, 41, 57, 71, 46, 24, 67, 75, 60, 89, 89, 126, 58, 46, 39, 59, 29, 46, 44, 86, 95, 37, 59, 22, 122, 73, 65, 60, 39, 46, 84, 34, 60, 32, 72, 57, 22, 65, 53, 61, 28, 60, 84, 75, 42, 30, 63, 42, 85, 52, 52, 48, 43, 88, 50, 47, 54, 99, 50, 81, 64, 84, 67, 84, 73, 43, 63, 24, 57, 105, 44, 44, 65, 70, 58, 60, 64, 86, 71, 73, 49, 67, 41, 83, 80, 20, 45, 72];
mean = [0.000000, 446, 428, 394, 392, 357, 341, 340, 293, 339, 320, 277, 280, 292, 274, 294, 261, 241, 238, 223, 228, 256, 191, 226, 219, 218, 205, 193, 177, 207, 213, 178, 174, 185, 158, 190, 190, 212, 159, 176, 172, 149, 176, 158, 170, 149, 144, 146, 147, 150, 140, 128, 125, 115, 125, 120, 521, 88, 87, 91, 86, 87, 77, 71, 96, 70, 58, 75, 81, 74, 80, 60, 71, 61, 70, 42, 42, 38, 73, 69, 54, 43, 37, 48, 45, 44, 49, 40, 41, 61, 60, 43, 37, 40, 40, 36, 50, 36, 38, 44, 37, 50, 39, 53, 18, 43, 35, 37, 34, 34, 44, 25, 36, 30, 26, 61, 39, 48, 35, 37, 30, 46, 36, 20, 50, 46, 31, 44, 40, 27, 27, 36, 52, 42, 45, 45, 60, 44, 34, 41, 33, 66, 57, 54, 45, 67, 100, 69, 89, 57, 74, 86, 100, 161, 122, 198, 137, 204, 216, 193, 263, 213, 321, 331, 318, 410, 478, 448, 523, 667, 746, 743, 878, 940, 938, 1173, 1150, 1041, 1304, 1331, 1428, 1554, 1635, 1694, 1708, 1877, 1823, 1801, 1981, 2234, 1904, 2160, 2336, 2239, 2377, 2224, 2458, 2557, 2550, 2586, 2226, 2366, 2468, 2452, 2264, 2185, 2324, 2385, 2169, 2301, 2228, 2063, 1964, 1957, 1953, 1905, 1866, 1929, 1696, 1688, 1660, 1556, 1459, 1584, 1494, 1486, 1698, 1427, 1519, 1318, 1427, 1379, 1348, 1268, 1456, 1377, 1572, 1271, 1337, 1443, 1351, 1282, 1309, 1452, 1193, 1422, 1532, 1537, 1609, 1603, 1540, 1409, 1757, 1811, 1593, 1641, 1651, 1828, 1968, 1958, 1852, 1904, 1958, 2116, 2264, 2142, 2076, 2084, 2178, 2107, 2272, 2310, 2032, 2315, 2218, 2338, 2189, 2069, 2389, 2106, 2052, 2260, 2097, 2141, 1997, 2240, 4064, 1909, 2870, 1865, 1871, 1751, 1790, 1727, 1500, 1601, 1450, 1443, 1344, 1224, 1383, 1363, 1269, 1291, 997, 1287, 1012, 955, 1015, 899, 886, 921, 897, 736, 782, 711, 736, 769, 782, 627, 617, 634, 650, 623, 601, 619, 565, 640, 686, 574, 565, 538, 607, 658, 642, 623, 733, 644, 696, 716, 684, 798, 702, 765, 760, 834, 743, 745, 748, 744, 764, 686, 686, 719, 796, 696, 681, 741, 753, 737, 741, 699, 800, 569, 622, 607, 692, 617, 639, 565, 498, 597, 545, 518, 508, 341, 429, 419, 389, 330, 288, 288, 253, 235, 250, 217, 222, 176, 198, 210, 183, 156, 165, 128, 142, 80, 129, 123, 65, 130, 137, 109, 127, 71, 78, 77, 72, 73, 69, 88, 73, 88, 91, 91, 103, 83, 87, 107, 53, 88, 73, 66, 116, 57, 76, 67, 68, 80, 82, 112, 107, 116, 140, 90, 133, 94, 103, 113, 124, 112, 135, 118, 134, 129, 142, 230, 105, 145, 116, 170, 166, 143, 186, 169, 174, 178, 177, 153, 132, 172, 204, 162, 203, 189, 226, 160, 210, 230, 241, 185, 183, 211, 218, 230, 157, 213, 220, 248, 197, 219, 230, 185, 213, 226, 225, 345, 272, 223, 306, 258, 297, 259, 315, 359, 369, 369, 349, 360, 393, 505];

binsize = 0.002;
ylog = log(y);
x = binsize:binsize:1;
figure(1);
bar(x, original)
figure(2)
bar(x, median)
figure(3)
bar(x, mean)




%% HU sensitivity


x = -700:0.5:800;
y = 1./x.^2;
plot(x,y)



%% Clustering Heuristic
clc
clear





[X,Y]= meshgrid(-600:800, 0:23);


% Lung tissue
huwidth = 200; sizewidth = 8000;
hucenter = -600; sizecenter = 0;
Z1 = 150 * exp( - ((X-hucenter).^2/huwidth^2   +   (Y-sizecenter).^2/sizewidth^2)    )   ;

% Bone tissue
huwidth = 550; sizewidth = 19;
hucenter = 1000; sizecenter = 23;
Z2 = 700 * exp( - ((X-hucenter).^2/huwidth^2   +   (Y-sizecenter).^2/sizewidth^2)    )   ;


% Noise probably
huwidth = 10000; sizewidth = 2;
hucenter = 0; sizecenter = 0;
Z3 = 30 * exp( - ((X-hucenter).^2/huwidth^2   +   (Y-sizecenter).^2/sizewidth^2)    )   ;

Z = 15 + Z1+Z2 + Z3;
%Z = 1./Z





%figure()
mesh(X,Y,Z)
hold on

xlabel('Houndsvield Value');
ylabel('log2(mm^2)');

% Muscles
plot3(80,log2(0.5*10^6),15, '-o','Color','b','MarkerSize',10,'MarkerFaceColor','red');
plot3(102,log2(2.3*10^6),15, '-o','Color','b','MarkerSize',10,'MarkerFaceColor','red');

%
hold off





%% HU to mass conversion for siemens machines (Not very precise)
clc
clear

mass = [0      0.29   0.45   0.943 0.985  1.000 1.016 1.052 1.089 1.145 1.159 1.335 1.560 1.823]';
hu =   [-969.8 -712.9 -536.5 -95.6 -45.6  -5.6 -1.9  25.7 65.6 207.5 220.7 429.9 775.3 1173.7]';


%plot(hu, mass)




f = @(b,hu) b(1).*exp(b(2).*hu)+b(3);                                     % Objective Function
B = fminsearch(@(b) norm(mass - f(b,hu)), [-0.2; -0.1; 0.8])                  % Estimate Parameters
figure
plot(hu, mass, 'pg')
hold on
plot(hu, f(B,hu), '-r')
hold off;
grid
xlabel('Houndsfield unit')
ylabel('Mass g/cm3')
text(27, 105, sprintf('f(x) = %.1f\\cdote^{%.3f\\cdotx}%+.1f', B))
